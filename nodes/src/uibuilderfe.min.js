"use strict";if(typeof require!=="undefined"&&typeof io==="undefined"){var io=require("socket.io-client")}(function(){var root=this;var previous_uibuilder=root.uibuilder;var uibuilder=function(){var self=this;self.version="1.0.7";self.debug=false;self.uiDebug=function(type,msg){if(!self.debug)return;this.myLog={};switch(type){case"error":this.myLog=console.error;break;case"warn":this.myLog=console.warn;break;case"info":this.myLog=console.info;break;case"dir":this.myLog=console.dir;break;default:this.myLog=console.log}this.myLog(msg)};self.me=function(){return self.debug===true?self:"uibuilderfe.js Version: "+self.version};self.setIOnamespace=function(){var ioNamespace="";ioNamespace=document.cookie.replace(/(?:(?:^|.*;\s*)uibuilder-namespace\s*\=\s*([^;]*?).*$)|^.*$/,"$1");if(ioNamespace===""){var u=window.location.pathname.split("/").filter(function(t){return t.trim()!==""});if(u[u.length-1].endsWith(".html"))u.pop();ioNamespace=u.join("/")}ioNamespace="/"+ioNamespace;self.uiDebug("log","uibuilderfe: IO Namespace: "+ioNamespace);return ioNamespace};self.autoSendReady=true;self.allowScript=true;self.allowStyle=true;self.removeScript=true;self.removeStyle=true;self.msg={};self.ctrlMsg={};self.sentMsg={};self.msgsSent=0;self.msgsReceived=0;self.msgsSentCtrl=0;self.msgsCtrl=0;self.ioConnected=false;self.ioChannels={control:"uiBuilderControl",client:"uiBuilderClient",server:"uiBuilder"};self.retryMs=2e3;self.retryFactor=1.5;self.timerid=null;self.ioNamespace=self.setIOnamespace();self.ioPath="/uibuilder/socket.io";self.ioTransport=["polling","websocket"];self.throttleCtrl=[];self.set=function(prop,val){self[prop]=val;self.uiDebug("log","uibuilderfe: prop set - prop: "+prop+", val: "+(typeof val==="object")?JSON.stringify(val):val);self.emit(prop,val)};self.socket=io(self.ioNamespace,{path:self.ioPath,transports:self.ioTransport});self.checkConnect=function(delay,factor){var depth=depth++||1;self.uiDebug("log","checkConnect. Depth: ",depth," , Delay: ",delay,", Factor: ",factor);if(self.timerid)window.clearTimeout(self.timerid);self.timerid=window.setTimeout(function(){self.uiDebug("log","checkConnect timeout. SIO reconnect attempt, timeout: "+delay+", depth: "+depth);self.socket.close();self.socket.connect();self.timerid=null;self.checkConnect(delay*factor,factor)},delay)};self.socket.on("connect",function(){self.uiDebug("log","uibuilderfe: SOCKET CONNECTED - Namespace: "+self.ioNamespace);self.set("ioConnected",true);if(self.timerid){window.clearTimeout(self.timerid);self.timerid=null}});self.socket.on(self.ioChannels.server,function(receivedMsg){self.uiDebug("info","uibuilderfe: socket.on.server - msg received - Namespace: "+self.ioNamespace);self.uiDebug("dir",receivedMsg);receivedMsg=makeMeAnObject(receivedMsg,"payload");if(self.allowScript&&receivedMsg.hasOwnProperty("script")){self.newScript(receivedMsg.script);if(self.removeScript)delete receivedMsg.script}if(self.allowStyle&&receivedMsg.hasOwnProperty("style")){self.newStyle(receivedMsg.style);if(self.removeStyle)delete receivedMsg.style}if(receivedMsg.hasOwnProperty("throttle")){self.set("throttleCtrl",receivedMsg.throttle)}self.set("msg",receivedMsg);self.set("msgsReceived",self.msgsReceived+1)});self.socket.on(self.ioChannels.control,function(receivedCtrlMsg){self.uiDebug("info","uibuilder:socket.on.control - msg received - Namespace: "+self.ioNamespace);self.uiDebug("dir",receivedCtrlMsg);if(receivedCtrlMsg===null){receivedCtrlMsg={}}else if(typeof receivedCtrlMsg!=="object"){receivedCtrlMsg={uibuilderCtrl:receivedCtrlMsg}}if(receivedCtrlMsg.hasOwnProperty("debug"))self.debug=receivedCtrlMsg.debug;if(receivedCtrlMsg.hasOwnProperty("throttle")){self.set("throttleCtrl",receivedCtrlMsg.throttle)}self.set("ctrlMsg",receivedCtrlMsg);self.set("msgsCtrl",self.msgsCtrl+1)});self.socket.on("disconnect",function(reason){self.uiDebug("log","SOCKET DISCONNECTED - Namespace: "+self.ioNamespace+", Reason: "+reason);self.set("ioConnected",false);if(reason==="io server disconnect"){self.checkConnect(self.retryMs,self.retryFactor)}});self.send=function(msgToSend,channel){if(channel===null||channel===undefined)channel=self.ioChannels.client;self.uiDebug("info","uibuilderfe: msg sent - Namespace: "+self.ioNamespace+", Channel: "+channel);self.uiDebug("dir",msgToSend);if(channel===self.ioChannels.client){msgToSend=makeMeAnObject(msgToSend,"payload")}else if(channel===self.ioChannels.control){msgToSend=makeMeAnObject(msgToSend,"uibuilderCtrl");if(!msgToSend.hasOwnProperty("uibuilderCtrl")){msgToSend.uibuilderCtrl="manual send"}msgToSend.from="client"}self.set("sentMsg",msgToSend);if(channel===self.ioChannels.client){self.set("msgsSent",self.msgsSent+1)}else if(channel===self.ioChannels.control){self.set("msgsCtrl",self.msgsCtrl+1)}var throttleDelay=0;var arr=self.throttleCtrl;for(var i=0;i<arr.length;i++){if(msgToSend[arr[i].propName]&&msgToSend[arr[i].propName]==arr[i].propValue){var max=arr[i].maxMillis;var min=arr[i].minMillis;throttleDelay=Math.floor(Math.random()*(max-min+1))+min;break}}if(self.timerid)window.clearTimeout(self.timerid);self.timerid=window.setTimeout(function(){self.socket.emit(channel,msgToSend);self.timerid=null},throttleDelay)};self.events={};self.emit=function(prop){var evt=self.events[prop];if(!evt){return}var args=Array.prototype.slice.call(arguments,1);for(var i=0;i<evt.length;i++){evt[i].apply(self,args)}};self.newScript=function(script){if(self.allowScript!==true)return;if(script===""||typeof script==="undefined")return;self.uiDebug("log","uibuilderfe: newCode - script: "+script);var newScript=document.createElement("script");newScript.type="text/javascript";newScript.defer=true;newScript.textContent=script;document.getElementsByTagName("body")[0].appendChild(newScript)};self.newStyle=function(style){if(self.allowStyle!==true)return;if(style===""||typeof style==="undefined")return;self.uiDebug("log","uibuilderfe: newStyle - style: "+style);var newStyle=document.createElement("style");newStyle.textContent=style;document.getElementsByTagName("head")[0].appendChild(newStyle)};self.uiReturn={set:function(prop,val){var excluded=["version","debug","msg","ctrlMsg","sentMsg","msgsSent","msgsSentCtrl","msgsReceived","msgsCtrl","ioConnected","ioChannels","retryMs","retryFactor","timerid","ioNamespace","ioPath","ioTransport","events","autoSendReady","set","get","send","sendCtrl","onChange","socket","checkConnect","emit","uiReturn","newScript","newStyle","uiDebug","me","self","setIOnamespace"];if(excluded.indexOf(prop)!==-1){self.uiDebug("warn",'uibuilderfe:uibuilder:set: "'+prop+'" is in list of excluded properties, not set');return}self.set(prop,val)},get:function(prop){return self[prop]},onChange:function(prop,callback){if(self.events[prop]){self.events[prop].push(callback)}else{self.events[prop]=[callback]}},msg:self.msg,send:self.send,sendCtrl:function(msg){self.send(msg,self.ioChannels.control)},autoSendReady:function(sw){if(sw!==true)sw=false;self.autoSendReady=sw},debug:function(onOff){if(typeof onOff==="undefined")return self.debug;if(typeof onOff==="boolean")self.debug=onOff},uiDebug:self.uiDebug,me:self.me};window.addEventListener("load",function(){if(self.autoSendReady===true){self.send({uibuilderCtrl:"ready for content",cacheControl:"REPLAY"},self.ioChannels.control)}});self.checkConnect(self.retryMs,self.retryFactor);return self.uiReturn}.call(root);uibuilder.noConflict=function(){root.uibuilder=previous_uibuilder;return uibuilder};if(typeof exports!=="undefined"){if(typeof module!=="undefined"&&module.exports){exports=module.exports=uibuilder}exports.uibuilder=uibuilder}else{root.uibuilder=uibuilder}function makeMeAnObject(thing,property){if(property===null||property===undefined)property="payload";if(typeof property!=="string"){console.warn("makeMeAnObject:WARNING: property parameter must be a string and not: "+typeof property);property="payload"}var out={};if(typeof thing==="object"){out=thing}else if(thing!==null){out[property]=thing}return out}}).call(this);